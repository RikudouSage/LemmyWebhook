<!-- TOC -->
* [API management](#api-management)
    * [Authentication / authorization](#authentication--authorization)
    * [REST api](#rest-api)
      * [Webhooks](#webhooks)
    * [Management commands](#management-commands)
      * [Create a user](#create-a-user)
      * [Approve/reject registration](#approvereject-registration)
      * [List available scopes](#list-available-scopes)
      * [Approve scopes for user](#approve-scopes-for-user)
      * [Check for scope requests to approve/reject](#check-for-scope-requests-to-approvereject)
<!-- TOC -->

# API management

This package contains an api for webhook management. It runs inside the container on port 80.

### Authentication / authorization

By default, users cannot register their own account, it can be enabled by setting the `API_REGISTRATION_ENABLED`
environment variable to `1`. When enabled, the account still has to be manually approved (either in db or through the api).

> In DB: `update users set enabled = true where id = :userId`

> Using API: `curl -H "Authorization: Bearer [apiKey]" -XPATCH http://localhost/rest/users/{userId} -d '{"data": {"type": "users", "id": {userId}, "attributes" {"enabled": true}}}'`

When a user is authorized, they only have access to webhooks created by them, unless they're an admin, in that case they
have access to all webhooks, including those without any user associated.

The api endpoints for authentication/authorization can be found at [openapi.yaml](../openapi.yaml).

### REST api

After successful authorization, you can call the `/rest` endpoints which follow the [JSON:API v1.0](https://jsonapi.org/format/1.0/) standard.

Api resources available:

- `users`
- `scopes`
- `webhooks`

#### Webhooks

The user can create webhooks only for object types that he has been approved for. Each user can ask for scope access
either during registration or separately. The user cannot create webhooks for object types they don't have access
to.

### Management commands

#### Create a user

If you don't have registration enabled, you can create users using a local command:

`docker exec -it lemmy_webhooks_1 bin/console app:user:create`

Here's the autogenerated documentation of the command:

```
Usage:
  app:user:create [options] [--] <username>

Arguments:
  username                 The username of the new user

Options:
      --admin              Whether to make the new user an admin who has access to everything.
      --password=PASSWORD  Provide the password instead of asking interactively for it. This might leak sensitive data.
      --scope=SCOPE        Add a scope that this user will have access to. (multiple values allowed)
```

So, for example, create an admin user called `my_admin_user`:

`docker exec -it lemmy_webhooks_1 bin/console app:user:create --admin my_admin_user`

Create a normal user called `some_user`:

`docker exec -it lemmy_webhooks_1 bin/console app:user:create --scope post --scope comment some_user`

Create a user and provide the password as an argument instead of letting the command ask you:

`docker exec -it lemmy_webhooks_1 bin/console app:user:create --admin --password SuperS3cret my_admin_user`

#### Approve/reject registration

Here's autogenerated documentation for the command:

```
Usage:
  app:user:approve [options] [--] <username>

Arguments:
  username              The username to approve.

Options:
      --reject          Reject the user registration instead of approving it.
```

#### List available scopes

Run the command `app:scope:list`, it accepts no arguments and prints output similar to the following:

```
comment
comment_report
community
instance
person
post
post_report
private_message
registration_application
```

#### Approve scopes for user

Here's autogenerated documentation for the command:

```
Usage:
  app:scope:approve [options] [--] <username>

Arguments:
  username              The username to approve the scopes for.

Options:
      --reject          Reject the scopes instead of approving them.
      --scope=SCOPE     The scopes to approve. (multiple values allowed)
```

#### Check for scope requests to approve/reject

Just run the interactive `app:scope:check` command and follow the on-screen instructions.
